<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Your Cart - TisdomEliphaz Digital Shop"/>
  <meta name="author" content="Tisdom Eliphaz"/>

  <title>üõí Cart | TisdomEliphaz Digital Shop</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="pi-logo.png" type="image/png">

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>
  <script src="firebase-config.js"></script>
</head>
<body>
  <header class="navbar sticky">
    <div class="nav-container">
      <a href="index.html" class="logo brand">TisdomEliphazDigitalShop</a>
      <nav>
        <ul id="nav-menu" class="nav-links">
          <li><a href="index.html">Home</a></li>
          <li><a href="dashboard.html">Dashboard</a></li>
          <li id="adminLink" style="display:none;"><a id="menu-admin" href="admin-dashboard.html">Admin Dashboard</a></li>
          <li><a href="register.html" id="menu-register">Register</a></li>
          <li><a href="login.html" id="menu-login">Login</a></li>
          <li><a href="settings.html">Settings</a></li>
          <li><a href="faqs.html">FAQs</a></li>
          <li id="logoutLink" style="display:none;"><a href="#" onclick="logout()">Logout</a></li>
          <li><a href="cart.html" class="cart-btn active">üõí Cart (<span id="cart-count">0</span>)</a></li>
        </ul>
      </nav>
      <button id="menu-toggle" class="mobile-menu">‚ò∞</button>
    </div>
  </header>

  <section class="section container">
    <h2>üõí Your Shopping Cart</h2>
    <div id="cart-items" class="cart-items">
      <div class="loading-spinner"></div>
      <p>Loading your cart...</p>
    </div>
    <div class="cart-summary">
      <p><b>Total:</b> <span id="cart-total">‚Ç¶0.00</span></p>
      <button id="checkout-btn" class="btn primary">Proceed to Checkout</button>
    </div>
  </section>

  <footer>
    <div class="footer-content container">
      <img src="pi-logo.png" alt="Pi Logo" class="footer-logo">
      <p>&copy; 2025 <b>TisdomEliphaz Digital Shop</b> | Powered by Pi Network</p>
    </div>
  </footer>

  <script type="module">
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { auth, db } from "./firebase-config.js";

    let cart = JSON.parse(localStorage.getItem("cart")) || [];

    function loadCartPage() {
      const cartItemsEl = document.getElementById("cart-items");
      cartItemsEl.innerHTML = "";

      if (!cart.length) {
        cartItemsEl.innerHTML = "<p>Your cart is empty üõí</p>";
        return;
      }

      cart.forEach((item, index) => {
        const itemEl = document.createElement("div");
        itemEl.classList.add("cart-item");

        itemEl.innerHTML = `
          ${item.imageUrl ? `<img src="${item.imageUrl}" alt="${item.title}" class="cart-item-image"/>` : ""}
          <div class="cart-item-details">
            <h3>${item.title}</h3>
            <p class="price">‚Ç¶${item.price}</p>
            <button class="btn danger remove-btn">‚ùå Remove</button>
          </div>
        `;

        itemEl.querySelector(".remove-btn").addEventListener("click", () => {
          cart.splice(index, 1);
          localStorage.setItem("cart", JSON.stringify(cart));
          updateCartUI();
          loadCartPage();
        });

        cartItemsEl.appendChild(itemEl);
      });

      updateCartUI();
    }

    function updateCartUI() {
      const cartCount = document.getElementById("cart-count");
      const cartTotal = document.getElementById("cart-total");
      cartCount.textContent = cart.length;
      const total = cart.reduce((sum, item) => sum + parseFloat(item.price || 0), 0);
      cartTotal.textContent = `‚Ç¶${total.toFixed(2)}`;
    }

    document.addEventListener("DOMContentLoaded", loadCartPage);

    document.getElementById("checkout-btn").addEventListener("click", async () => {
      if (!cart.length) return alert("‚ùå Your cart is empty!");

      const user = auth.currentUser;
      if (!user) return alert("‚ö†Ô∏è Please login first to checkout.");

      try {
        const order = {
          userId: user.uid,
          email: user.email,
          items: cart,
          total: cart.reduce((sum, item) => sum + parseFloat(item.price || 0), 0),
          createdAt: new Date(),
          status: "pending"
        };

        await addDoc(collection(db, "orders"), order);

        alert("‚úÖ Order placed successfully! We will contact you soon.");
        cart = [];
        localStorage.setItem("cart", JSON.stringify(cart));
        updateCartUI();
        loadCartPage();
      } catch (err) {
        console.error(err);
        alert("‚ùå Failed to place order: " + err.message);
      }
    });
  </script>
</body>
</html>