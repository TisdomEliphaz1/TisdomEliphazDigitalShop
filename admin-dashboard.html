<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard â€“ TisdomEliphazDigitalShop</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f3f3; display: flex; }
    .sidebar { width: 250px; background-color: #232f3e; color: white; min-height: 100vh; display: flex; flex-direction: column; }
    .sidebar h2 { text-align: center; padding: 20px 0; margin: 0; font-size: 1.5rem; border-bottom: 1px solid #39414f; }
    .sidebar ul { list-style: none; padding: 0; margin: 0; flex-grow: 1; }
    .sidebar li { padding: 15px 20px; cursor: pointer; border-bottom: 1px solid #39414f; transition: background 0.2s; }
    .sidebar li:hover, .sidebar li.active { background-color: #37475a; }
    .sidebar li a { color: white; text-decoration: none; display: block; }
    .main-content { flex-grow: 1; padding: 20px; overflow-x: auto; }
    .dashboard-header { display: flex; justify-content: space-between; align-items: center; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
    .stat-card, .section-card { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
    th { background-color: #f0f0f0; }
    footer { text-align: center; padding: 15px; margin-top: 20px; background-color: #232f3e; color: white; }
  </style>
</head>
<body>
  <aside class="sidebar">
    <h2>Admin</h2>
    <ul>
      <li class="active"><a href="admin-dashboard.html">ðŸ“Š Dashboard</a></li>
      <li><a href="#products-section">ðŸ“¤ Products</a></li>
      <li><a href="#orders-section">ðŸ“¦ Orders</a></li>
      <li><a href="#users-section">ðŸ‘¥ Users</a></li>
      <li><a href="#notice-section">ðŸ”” Notices</a></li>
      <li><a href="#" id="logoutBtn">ðŸšª Logout</a></li>
    </ul>
  </aside>

  <div class="main-content">
    <div class="dashboard-header">
      <h1>Welcome, Admin ðŸ‘‘</h1>
      <p id="adminEmail"></p>
    </div>

    <div class="stats-grid">
      <div class="stat-card"><h3>Total Orders</h3><p id="totalOrders">0</p></div>
      <div class="stat-card"><h3>Total Users</h3><p id="totalUsers">0</p></div>
      <div class="stat-card"><h3>Total Products</h3><p id="totalProducts">0</p></div>
    </div>

    <div class="section-card" id="products-section">
      <h3>ðŸ“¤ Upload Product</h3>
      <form id="uploadForm">
        <input type="text" id="productTitle" placeholder="Product Title" required><br>
        <textarea id="productDescription" placeholder="Product Description"></textarea><br>
        <input type="number" id="productPrice" placeholder="Product Price (â‚¦)" required><br>
        <input type="file" id="productImage" accept="image/*"><br>
        <input type="file" id="productVideo" accept="video/*"><br>
        <button type="submit">Upload</button>
      </form>
    </div>

    <div class="section-card" id="orders-section">
      <h3>ðŸ“¦ Recent Orders</h3>
      <table id="ordersTable">
        <thead>
          <tr><th>Order ID</th><th>User</th><th>Total (â‚¦)</th><th>Status</th><th>Date</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="section-card" id="users-section">
      <h3>ðŸ‘¥ Manage Users</h3>
      <table id="usersTable">
        <thead>
          <tr><th>Email</th><th>Role</th><th>Registered At</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="section-card" id="notice-section">
      <h3>ðŸ”” Notice Board</h3>
      <textarea id="noticeInput" placeholder="Type new notice..."></textarea>
      <button id="updateNoticeBtn">Update Notice</button>
    </div>

    <footer>
      <p>Â© 2025 TisdomEliphazDigitalShop | Admin Portal</p>
    </footer>
  </div>

  <script type="module">
    import { auth, db, storage } from "./firebase-config.js";
    import { logout } from "./auth.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { 
      collection, doc, setDoc, addDoc, query, orderBy, limit, onSnapshot 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

    const adminEmailEl = document.getElementById("adminEmail");
    const logoutBtn = document.getElementById("logoutBtn");

    // Protect Admin Route
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        adminEmailEl.innerText = "Logged in as: " + user.email;
        if (user.email !== "tisdomeliphazdigitalshop@gmail.com") {
          alert("âŒ Access Denied: You are not an admin!");
          window.location.href = "dashboard.html";
        } else {
          initRealtimeListeners();
        }
      } else {
        window.location.href = "login.html"; // Fixed
      }
    });

    // Logout
    logoutBtn.addEventListener("click", async (e) => {
      e.preventDefault();
      await logout();
    });

    // Notice
    document.getElementById("updateNoticeBtn").addEventListener("click", async () => {
      const input = document.getElementById("noticeInput").value.trim();
      if (input) {
        await setDoc(doc(db, "notices", "mainNotice"), { text: input });
        alert("âœ… Notice updated!");
      }
    });

    // Upload Product
    document.getElementById("uploadForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const title = document.getElementById("productTitle").value;
      const description = document.getElementById("productDescription").value;
      const price = document.getElementById("productPrice").value;
      const imageFile = document.getElementById("productImage").files[0];
      const videoFile = document.getElementById("productVideo").files[0];

      try {
        let imageUrl = "", videoUrl = "";
        if (imageFile) {
          const imgRef = ref(storage, "products/" + imageFile.name);
          await uploadBytes(imgRef, imageFile);
          imageUrl = await getDownloadURL(imgRef);
        }
        if (videoFile) {
          const vidRef = ref(storage, "products/" + videoFile.name);
          await uploadBytes(vidRef, videoFile);
          videoUrl = await getDownloadURL(vidRef);
        }

        await addDoc(collection(db, "products"), {
          title, description, price, imageUrl, videoUrl, createdAt: new Date()
        });

        alert("âœ… Product uploaded!");
        document.getElementById("uploadForm").reset();
      } catch (err) { alert("âŒ " + err.message); }
    });

    // Realtime Listeners
    function initRealtimeListeners() {
      onSnapshot(collection(db, "orders"), snap => {
        document.getElementById("totalOrders").innerText = snap.size;
      });
      onSnapshot(collection(db, "users"), snap => {
        document.getElementById("totalUsers").innerText = snap.size;
      });
      onSnapshot(collection(db, "products"), snap => {
        document.getElementById("totalProducts").innerText = snap.size;
      });

      const ordersTable = document.getElementById("ordersTable").querySelector("tbody");
      const ordersQ = query(collection(db, "orders"), orderBy("createdAt", "desc"), limit(10));
      onSnapshot(ordersQ, (snap) => {
        ordersTable.innerHTML = "";
        snap.forEach(docSnap => {
          const order = docSnap.data();
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${docSnap.id}</td>
                          <td>${order.userEmail || '-'}</td>
                          <td>${order.total || 0}</td>
                          <td>${order.status || 'Pending'}</td>
                          <td>${order.createdAt?.toDate().toLocaleString() || '-'}</td>`;
          ordersTable.appendChild(tr);
        });
      });

      const usersTable = document.getElementById("usersTable").querySelector("tbody");
      const usersQ = query(collection(db, "users"), orderBy("createdAt", "desc"));
      onSnapshot(usersQ, (snap) => {
        usersTable.innerHTML = "";
        snap.forEach(docSnap => {
          const user = docSnap.data();
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${user.email}</td>
                          <td>${user.role || 'User'}</td>
                          <td>${user.createdAt?.toDate().toLocaleString() || '-'}</td>`;
          usersTable.appendChild(tr);
        });
      });
    }
  </script>
</body>
</html>